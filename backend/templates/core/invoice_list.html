{% extends 'core/base.html' %}

{% block title %}Invoices - Alpha LPGas{% endblock %}
{% block nav_invoices %}active{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1><i class="bi bi-receipt"></i> Invoices</h1>
    </div>
    <div class="col-md-6 text-end">
        <a href="{% url 'accounting_forms:invoice_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> New Invoice
        </a>
        <a href="{% url 'accounting_forms:dashboard' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Dashboard
        </a>
    </div>
</div>

<!-- Search Bar -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="position-relative">
            <input type="text" id="search-input" class="form-control" 
                   placeholder="Search by invoice #, client name, customer ID, or status..." 
                   value="{{ search_query }}" autofocus>
            <div id="search-spinner" class="position-absolute top-50 end-0 translate-middle-y me-3" style="display: none;">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Searching...</span>
                </div>
            </div>
        </div>
        <small class="text-muted">Search updates automatically as you type</small>
    </div>
    <div class="col-md-6">
        <div id="search-results-info" class="alert alert-info mb-0" style="display: none;">
            <span id="results-text"></span>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if invoices %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th class="sortable" data-sort="invoice_number">
                            Invoice #
                            {% if sort_by == 'invoice_number' %}<i class="bi bi-caret-up-fill"></i>{% elif sort_by == '-invoice_number' %}<i class="bi bi-caret-down-fill"></i>{% else %}<i class="bi bi-caret-down text-muted"></i>{% endif %}
                        </th>
                        <th class="sortable" data-sort="client__name">
                            Client
                            {% if sort_by == 'client__name' %}<i class="bi bi-caret-up-fill"></i>{% elif sort_by == '-client__name' %}<i class="bi bi-caret-down-fill"></i>{% else %}<i class="bi bi-caret-down text-muted"></i>{% endif %}
                        </th>
                        <th class="sortable" data-sort="issue_date">
                            Issue Date
                            {% if sort_by == 'issue_date' %}<i class="bi bi-caret-up-fill"></i>{% elif sort_by == '-issue_date' %}<i class="bi bi-caret-down-fill"></i>{% else %}<i class="bi bi-caret-down text-muted"></i>{% endif %}
                        </th>
                        <th class="sortable" data-sort="due_date">
                            Due Date
                            {% if sort_by == 'due_date' %}<i class="bi bi-caret-up-fill"></i>{% elif sort_by == '-due_date' %}<i class="bi bi-caret-down-fill"></i>{% else %}<i class="bi bi-caret-down text-muted"></i>{% endif %}
                        </th>
                        <th class="sortable" data-sort="total_amount">
                            Total
                            {% if sort_by == 'total_amount' %}<i class="bi bi-caret-up-fill"></i>{% elif sort_by == '-total_amount' %}<i class="bi bi-caret-down-fill"></i>{% else %}<i class="bi bi-caret-down text-muted"></i>{% endif %}
                        </th>
                        <th class="sortable" data-sort="paid_amount">
                            Paid
                            {% if sort_by == 'paid_amount' %}<i class="bi bi-caret-up-fill"></i>{% elif sort_by == '-paid_amount' %}<i class="bi bi-caret-down-fill"></i>{% else %}<i class="bi bi-caret-down text-muted"></i>{% endif %}
                        </th>
                        <th>Balance</th>
                        <th class="sortable" data-sort="status">
                            Status
                            {% if sort_by == 'status' %}<i class="bi bi-caret-up-fill"></i>{% elif sort_by == '-status' %}<i class="bi bi-caret-down-fill"></i>{% else %}<i class="bi bi-caret-down text-muted"></i>{% endif %}
                        </th>
                        <th>WhatsApp</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td><code>{{ invoice.invoice_number }}</code></td>
                        <td>{{ invoice.client.name }}</td>
                        <td>{{ invoice.issue_date|date:"Y-m-d" }}</td>
                        <td>{{ invoice.due_date|date:"Y-m-d" }}</td>
                        <td>R {{ invoice.total_amount|floatformat:2 }}</td>
                        <td>R {{ invoice.paid_amount|floatformat:2 }}</td>
                        <td>R {{ invoice.balance|floatformat:2 }}</td>
                        <td>
                            {% if invoice.status == 'paid' %}
                            <span class="badge bg-success">Paid</span>
                            {% elif invoice.status == 'partially_paid' %}
                            <span class="badge bg-info">Partial</span>
                            {% elif invoice.status == 'overdue' %}
                            <span class="badge bg-danger">Overdue</span>
                            {% else %}
                            <span class="badge bg-warning">{{ invoice.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if invoice.whatsapp_sent %}
                                <span class="badge bg-success" title="{{ invoice.whatsapp_sent_at|date:'Y-m-d H:i' }}"><i class="fab fa-whatsapp"></i> Sent</span>
                            {% else %}
                                <span class="badge bg-secondary"><i class="fab fa-whatsapp"></i> Not Sent</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'accounting_forms:invoice_detail' invoice.invoice_number %}" 
                                   class="btn btn-outline-primary" title="View">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="text-muted mt-3">Total: {{ invoices.count }} invoice{{ invoices.count|pluralize }}</p>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-receipt" style="font-size: 4rem; color: #ccc;"></i>
            {% if search_query %}
            <h3 class="mt-3">No Invoices Found</h3>
            <p class="text-muted">No invoices match your search "{{ search_query }}"</p>
            <a href="{% url 'accounting_forms:invoice_list' %}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Clear Search
            </a>
            {% else %}
            <h3 class="mt-3">No Invoices Yet</h3>
            <p class="text-muted">Create your first invoice</p>
            <a href="{% url 'accounting_forms:invoice_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create First Invoice
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background-color: #495057 !important; }
</style>
<script>
// Current sort state
let currentSort = '{{ sort_by }}';

// Sorting functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const field = this.dataset.sort;
            let newSort;
            if (currentSort === field) {
                newSort = '-' + field;
            } else if (currentSort === '-' + field) {
                newSort = field;
            } else {
                newSort = '-' + field;
            }
            const url = new URL(window.location.href);
            url.searchParams.set('sort', newSort);
            window.location.href = url.toString();
        });
    });
});

// Real-time AJAX search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchSpinner = document.getElementById('search-spinner');
    const searchResultsInfo = document.getElementById('search-results-info');
    const resultsText = document.getElementById('results-text');
    const tableContainer = document.querySelector('.table-responsive');
    const emptyState = document.querySelector('.text-center.py-5');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        searchSpinner.style.display = 'block';

        searchTimeout = setTimeout(function() {
            performSearch(query);
        }, 300);
    });

    function performSearch(query) {
        const url = new URL(window.location.href);
        url.searchParams.set('search', query);

        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const newTableContainer = doc.querySelector('.table-responsive');
            const newEmptyState = doc.querySelector('.text-center.py-5');
            const invoiceCount = doc.querySelectorAll('tbody tr').length;

            if (newTableContainer) {
                if (tableContainer) {
                    tableContainer.outerHTML = newTableContainer.outerHTML;
                }
                if (emptyState) {
                    emptyState.style.display = 'none';
                }
            } else if (newEmptyState) {
                if (emptyState) {
                    emptyState.innerHTML = newEmptyState.innerHTML;
                    emptyState.style.display = 'block';
                }
                if (tableContainer) {
                    tableContainer.style.display = 'none';
                }
            }

            if (query) {
                searchResultsInfo.style.display = 'block';
                resultsText.textContent = `Found ${invoiceCount} result${invoiceCount !== 1 ? 's' : ''} for "${query}"`;
            } else {
                searchResultsInfo.style.display = 'none';
            }

            searchSpinner.style.display = 'none';

            if (query) {
                window.history.pushState({}, '', url);
            } else {
                window.history.pushState({}, '', window.location.pathname);
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            searchSpinner.style.display = 'none';
        });
    }
});
</script>
{% endblock %}
