{% extends 'core/base.html' %}
{% load static %}

{% block title %}Statement - {{ client.name }} - Alpha LPGas{% endblock %}

{% block content %}
<div class="container mt-4 mb-4">
    <!-- Header and Action Buttons -->
    <div class="print-hide">
        <div class="row mb-4">
            <div class="col-md-6">
                <h1><i class="bi bi-file-text"></i> Statement - {{ client.name }}</h1>
            </div>
            <div class="col-md-6 text-end">
                <button onclick="printStatementWithCustomFilename()" class="btn btn-info">
                    <i class="bi bi-printer"></i> Print
                </button>
                <a href="{% url 'accounting_forms:client_statement' client.pk %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </div>
    </div>

    <div class="statement-container">
        <style>
            .statement-container {
                padding: 2rem;
                background: white;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
            }

            .tagline {
                font-size: 1.2rem;
                color: #666;
                text-align: center;
                width: 100%;
                padding: 0.75rem 0;
                margin-bottom: 2rem;
                border-bottom: 1px solid #dee2e6;
            }

            .header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 2rem;
            }

            .company-section {
                flex: 1;
                max-width: 50%;
            }

            .logo {
                max-width: 360px;
                height: auto;
                margin-bottom: 1.5rem;
            }

            .company-details {
                font-size: 0.9rem;
                line-height: 1.6;
            }

            .statement-details {
                min-width: 350px;
                text-align: right;
            }

            .statement-title {
                font-size: 2rem;
                font-weight: bold;
                color: #003399;
                margin-bottom: 2rem;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .statement-info-row {
                display: flex;
                justify-content: flex-end;
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
            }

            .statement-info-label {
                font-weight: 500;
                width: 120px;
                text-align: left;
                padding-right: 1rem;
            }

            .statement-info-value {
                width: 150px;
                text-align: left;
                font-weight: bold;
            }

            .info-summary-section {
                display: flex;
                justify-content: space-between;
                margin-top: 2rem;
                padding-top: 2rem;
                border-top: 1px solid #dee2e6;
            }

            .client-info {
                flex: 1;
                max-width: 50%;
            }

            .client-info-title {
                font-weight: bold;
                margin-bottom: 1rem;
                color: #003399;
            }

            .client-info-content {
                font-size: 0.9rem;
                line-height: 1.6;
            }

            .account-summary {
                min-width: 350px;
            }

            .account-summary-title {
                font-weight: bold;
                margin-bottom: 1rem;
                color: #003399;
                text-align: right;
            }

            .account-summary-row {
                display: flex;
                justify-content: flex-end;
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
            }

            .account-summary-label {
                font-weight: 600;
                color: #495057;
                white-space: nowrap;
                width: 150px;
                text-align: left;
                padding-right: 1rem;
            }

            .account-summary-value {
                width: 120px;
                text-align: right;
                font-weight: bold;
            }

            .account-summary-total {
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid #dee2e6;
            }

            .account-summary-total .account-summary-label,
            .account-summary-total .account-summary-value {
                font-size: 1.1rem;
                color: #003399;
            }

            .table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 1rem;
                font-size: 0.9rem;
            }

            .table th, .table td {
                padding: 0.75rem;
                border-bottom: 1px solid #dee2e6;
                text-align: left;
            }

            .table th {
                background-color: #f8f9fa;
                font-weight: 600;
                color: #495057;
                font-size: 0.85rem;
            }

            .table tbody tr:hover {
                background-color: #f8f9fa;
            }

            .table .currency {
                font-family: monospace;
            }
            
            .description-cell {
                word-wrap: break-word;
                word-break: break-word;
                max-width: 200px;
                white-space: normal;
            }

            .table tfoot td {
                border-top: 1px solid #dee2e6;
                font-weight: bold;
            }

            .table tfoot .total-row td {
                border-top: 2px solid #dee2e6;
            }

            .aging-summary {
                margin-top: 2rem;
            }

            .aging-summary table {
                width: 100%;
                margin-bottom: 1rem;
                background-color: #f8f9fa;
            }

            .aging-summary th {
                text-align: right;
                padding: 0.75rem;
                font-size: 0.85rem;
                font-weight: 600;
                color: #495057;
                border-bottom: 2px solid #dee2e6;
                white-space: nowrap;
            }

            .aging-summary td {
                text-align: right;
                padding: 0.75rem;
                font-weight: bold;
                color: #003399;
            }

            .aging-summary .credit-label {
                text-align: left;
            }

            .aging-summary .total-due {
                color: #003399;
                font-size: 1.1rem;
            }

            .statement-footer {
                margin-top: 3rem;
                padding-top: 2rem;
                border-top: 1px solid #dee2e6;
            }

            .statement-footer-content {
                text-align: center;
                color: #495057;
            }

            .payment-info {
                font-weight: bold;
                color: #003399;
                margin-bottom: 1rem;
            }

            .thank-you {
                font-size: 1.1rem;
                margin-bottom: 1rem;
            }

            .contact-info {
                margin-bottom: 1rem;
            }

            .company-footer {
                font-size: 0.9rem;
                color: #666;
            }

            @media print {
                .no-print, .print-hide, .navbar-brand, .tagline {
                    display: none !important;
                }
                .container {
                    width: 97% !important;
                    max-width: 97% !important;
                    padding: 0.125cm !important;
                    margin-left: auto !important;
                    margin-right: auto !important;
                }
                .statement-container {
                    box-shadow: none;
                    padding: 0.75cm;
                    margin: 0 auto;
                    width: 100%;
                }
                
                /* Set page margins for printing */
                @page {
                    size: A4;
                    margin: 0.5cm;
                }
                
                /* Adjust header for print */
                .header {
                    margin-bottom: 0.75cm;
                }
                
                /* Adjust logo size for print */
                .logo {
                    max-width: 4cm;
                }
                
                /* Table print styling */
                .table {
                    font-size: 8pt;
                    page-break-inside: auto;
                    border-collapse: collapse !important;
                    table-layout: fixed;
                    width: 100%;
                }
                
                .table th {
                    font-size: 8pt;
                    background-color: #f8f9fa !important;
                    color: #000 !important;
                }
                
                .table th, .table td {
                    padding: 0.2cm;
                    border: 1px solid #dee2e6 !important;
                }
                
                /* Ensure content fits on page */
                .info-summary-section,
                .aging-summary,
                .statement-footer {
                    page-break-inside: avoid;
                }
                
                /* Allow transactions table to break across pages */
                .transactions-section {
                    page-break-inside: auto;
                    margin-top: 1cm;
                    margin-bottom: 1cm;
                }
                
                /* Table pagination controls */
                .table thead {
                    display: table-header-group;
                }
                
                .table tbody {
                    display: table-row-group;
                }
                
                .table tfoot {
                    display: table-footer-group;
                }
                
                .table tr {
                    page-break-inside: avoid;
                }
                
                /* Ensure table rows don't break across pages if they're very short */
                .table tr {
                    break-inside: avoid;
                }
                
                /* Remove Bootstrap card styling in print */
                .table-responsive {
                    overflow-x: visible !important;
                    border: none !important;
                }
                
                /* Ensure description cell wraps text properly in print */
                .description-cell {
                    word-wrap: break-word !important;
                    word-break: break-word !important;
                    white-space: normal !important;
                    max-width: 150px !important;
                    width: 25% !important;
                    overflow-wrap: break-word !important;
                }
                
                /* Set column widths for print */
                .table th:nth-child(1), .table td:nth-child(1) { width: 10% !important; } /* Date */
                .table th:nth-child(2), .table td:nth-child(2) { width: 10% !important; } /* Invoice # */
                .table th:nth-child(3), .table td:nth-child(3) { width: 40% !important; } /* Description */
                .table th:nth-child(4), .table td:nth-child(4) { width: 10% !important; } /* Debit */
                .table th:nth-child(5), .table td:nth-child(5) { width: 10% !important; } /* Credit */
                .table th:nth-child(6), .table td:nth-child(6) { width: 10% !important; } /* Balance */
            }
        </style>

        <!-- Tagline -->
        <div class="tagline">LP Gas Door-2-Door Delivery</div>

        <!-- Header Section -->
        <div class="header">
            <!-- Company Info -->
            <div class="company-section">
                <img src="{% static 'alpha-lpgas-logo.png' %}" alt="Alpha LPGas Logo" class="logo">
                <div class="company-details">
                    <div>Company REG No.: 2023/822513/07</div>
                    <div>VAT No.: 9415223222</div>
                    <div>Sunny Acres Shopping Centre</div>
                    <div>Sunnydale</div>
                    <div>Capetown</div>
                    <div>Cell: 074 454 5665</div>
                    <div>Email: info@alphalpgas.co.za</div>
                </div>
            </div>

            <!-- Statement Info -->
            <div class="statement-details">
                <div class="statement-title">Statement</div>
                <div class="statement-info-row">
                    <div class="statement-info-label">Date:</div>
                    <div class="statement-info-value">{{ statement_date|date:"d.m.Y" }}</div>
                </div>
                <div class="statement-info-row">
                    <div class="statement-info-label">Statement #:</div>
                    <div class="statement-info-value">{{ statement_number }}</div>
                </div>
                <div class="statement-info-row">
                    <div class="statement-info-label">Customer ID:</div>
                    <div class="statement-info-value">{{ client.customer_id }}</div>
                </div>
                <div class="statement-info-row">
                    <div class="statement-info-label">Start Date:</div>
                    <div class="statement-info-value">{{ start_date|date:"d.m.Y" }}</div>
                </div>
                <div class="statement-info-row">
                    <div class="statement-info-label">End Date:</div>
                    <div class="statement-info-value">{{ end_date|date:"d.m.Y" }}</div>
                </div>
                <div class="statement-info-row">
                    <div class="statement-info-label">Page:</div>
                    <div class="statement-info-value">Page 1 of 1</div>
                </div>
            </div>
        </div>

        <!-- Client Info and Account Summary -->
        <div class="info-summary-section">
            <!-- Client Info -->
            <div class="client-info">
                <div class="client-info-title">To:</div>
                <div class="client-info-content">
                    <div>ATT: {{ client.name }}</div>
                    {% if client.vat_number %}
                    <div>VAT No.: {{ client.vat_number }}</div>
                    {% endif %}
                    <div class="client-address">{{ client.address }}</div>
                    <div>Phone: {{ client.phone }}</div>
                    <div>Email: {{ client.email|default:'' }}</div>
                </div>
            </div>

            <!-- Account Summary -->
            <div class="account-summary">
                <div class="account-summary-title">Account Summary</div>
                <div class="account-summary-row">
                    <div class="account-summary-label">Balance Brought Forward</div>
                    <div class="account-summary-value">R{{ balance_bf|default:"0.00"|floatformat:2 }}</div>
                </div>
                <div class="account-summary-row">
                    <div class="account-summary-label">Invoices (Period)</div>
                    <div class="account-summary-value">R{{ total_invoices|default:"0.00"|floatformat:2 }}</div>
                </div>
                <div class="account-summary-row">
                    <div class="account-summary-label">Payments & Credits (Period)</div>
                    <div class="account-summary-value">R{{ total_credits|default:"0.00"|floatformat:2 }}</div>
                </div>
                <div class="account-summary-row account-summary-total">
                    <div class="account-summary-label">Total Balance Due</div>
                    <div class="account-summary-value">R{{ current_balance|floatformat:2 }}</div>
                </div>
            </div>
        </div>

        <!-- Statement Table -->
        <div class="transactions-section">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Invoice #</th>
                                <th>Description</th>
                                <th class="text-end">Debit</th>
                                <th class="text-end">Credit</th>
                                <th class="text-end">Balance</th>
                                <th class="no-print">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if balance_bf %}
                            <tr class="table-secondary">
                                <td>{{ start_date|date:"Y-m-d" }}</td>
                                <td></td>
                                <td class="description-cell">Balance b/d</td>
                                <td class="text-end currency"></td>
                                <td class="text-end currency"></td>
                                <td class="text-end currency">R{{ balance_bf|floatformat:2 }}</td>
                                <td class="no-print">
                                    <span class="badge bg-secondary">B/D</span>
                                </td>
                            </tr>
                            {% endif %}
                            {% for trans in transactions %}
                            <tr>
                                <td>{{ trans.date|date:"Y-m-d" }}</td>
                                <td>{{ trans.reference }}</td>
                                <td class="description-cell">{{ trans.description }}</td>
                                <td class="text-end currency">{% if trans.debit %}R{{ trans.debit|floatformat:2 }}{% endif %}</td>
                                <td class="text-end currency">{% if trans.credit %}R{{ trans.credit|floatformat:2 }}{% endif %}</td>
                                <td class="text-end currency">R{{ trans.balance|floatformat:2 }}</td>
                                <td class="no-print">
                                    {% if trans.type == 'invoice' %}
                                        <span class="badge {% if trans.object.status == 'paid' %}bg-success{% elif trans.object.status == 'partially_paid' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ trans.object.get_status_display }}
                                        </span>
                                    {% elif trans.type == 'payment' %}
                                        <span class="badge bg-success">Payment</span>
                                    {% elif trans.type == 'credit_note' %}
                                        <span class="badge bg-info">Credit Note</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No transactions found for the selected period.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        <!-- Aging Summary -->
        <div class="aging-summary">
            <table>
                <thead>
                    <tr>
                        <th class="credit-label">CREDIT ON ACCOUNT</th>
                        <th>Over 90 Days<br>Past Due</th>
                        <th>61 - 90 Days<br>Past Due</th>
                        <th>31-60 Days<br>Past Due</th>
                        <th>30 Days<br>Past Due</th>
                        <th>CURRENT</th>
                        <th class="total-due">TOTAL DUE</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="credit-label">R{{ aging.credit|default:"0.00"|floatformat:2 }}</td>
                        <td>R{{ aging.over_90|default:"0.00"|floatformat:2 }}</td>
                        <td>R{{ aging.days_61_90|default:"0.00"|floatformat:2 }}</td>
                        <td>R{{ aging.days_31_60|default:"0.00"|floatformat:2 }}</td>
                        <td>R{{ aging.days_1_30|default:"0.00"|floatformat:2 }}</td>
                        <td>R{{ aging.current|default:"0.00"|floatformat:2 }}</td>
                        <td class="total-due">R{{ current_balance|default:"0.00"|floatformat:2 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Statement Footer -->
        <div class="statement-footer">
            <div class="statement-footer-content">
                <div class="payment-info">
                    Make all EFTs payable to Alpha LPGas
                </div>
                <div class="thank-you">
                    Thank you for your business!
                </div>
                <div class="contact-info">
                    Should you have any enquiries concerning this statement, please contact Grace on 074 454 5665
                </div>
                <div class="company-footer">
                    <div>Sunny Acres Shopping Centre Lekkerwater, Sunnydale, Western Cape</div>
                    <div>Tel: 074 454 5665 | Email: info@alphalpgas.co.za | Web: alphalpgas.co.za</div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to print statement with custom filename
    function printStatementWithCustomFilename() {
        // Get client name and date information
        const clientName = "{{ client.name }}";
        
        // Set filename based on whether date range is provided
        let filename = "";
        // Using Django template variables in JavaScript
        const hasStartDate = "{{ request.GET.start_date }}" !== "";
        const hasEndDate = "{{ request.GET.end_date }}" !== "";
        
        if (hasStartDate && hasEndDate) {
            filename = "Statement - {{ client.name|escapejs }} - {{ request.GET.start_date|escapejs }} to {{ request.GET.end_date|escapejs }}";
        } else {
            filename = "Statement - {{ client.name|escapejs }} - {{ statement_date|date:'Y-m-d'|escapejs }}";
        }
        
        // Set the document title to be used as the filename when saving
        const originalTitle = document.title;
        document.title = filename;
        
        // Print the document
        window.print();
        
        // Restore the original title after printing
        setTimeout(function() {
            document.title = originalTitle;
        }, 1000);
    }
    
    // Function to show toast notifications instead of alerts
    function showToast(message, type) {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create a unique ID for this toast
        const toastId = 'toast-' + Date.now();
        
        // Map type to Bootstrap color class
        const typeClass = type === 'danger' ? 'bg-danger' : 
                         type === 'warning' ? 'bg-warning' : 
                         type === 'success' ? 'bg-success' : 'bg-info';
        
        // Create toast element
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header ${typeClass} text-white">
                    <strong class="me-auto">Notification</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        // Add toast to container
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Initialize and show the toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            autohide: type !== 'danger' && type !== 'warning',
            delay: 5000
        });
        toast.show();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // WhatsApp sharing functionality with Google Drive integration
        document.addEventListener('click', function(e) {
            // Use event delegation to handle clicks on WhatsApp share buttons
            if (e.target.closest('.whatsapp-share')) {
                e.preventDefault();
                
                const button = e.target.closest('.whatsapp-share');
                const clientName = button.getAttribute('data-client');
                const statementDate = button.getAttribute('data-date');
                const balanceDue = button.getAttribute('data-balance');
                const clientId = "{{ client.id }}";
                
                // Debug information
                console.log('WhatsApp share clicked for statement');
                console.log('Client:', clientName);
                console.log('Statement Date:', statementDate);
                console.log('Balance Due:', balanceDue);
                
                // Show loading indicator
                const originalButtonText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                button.disabled = true;
                
                // Get current URL parameters for date range
                const urlParams = new URLSearchParams(window.location.search);
                const startDate = urlParams.get('start_date') || '';
                const endDate = urlParams.get('end_date') || '';
                
                // Build the API URL with query parameters
                let apiUrl = `/api/whatsapp-share/statement/${clientId}/`;
                if (startDate || endDate) {
                    apiUrl += '?';
                    if (startDate) apiUrl += `start_date=${startDate}`;
                    if (startDate && endDate) apiUrl += '&';
                    if (endDate) apiUrl += `end_date=${endDate}`;
                }
                
                // Call our new API endpoint to save PDF to Google Drive
                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to prepare statement: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Get the message template with placeholders replaced
                            let message = data.template;
                            
                            // Google Drive functionality is still used for saving, but link is not added to message
                            if (data.google_drive && data.google_drive.success) {
                                console.log('Statement saved to Google Drive:', data.google_drive.view_url);
                            } else if (data.google_drive && !data.google_drive.success) {
                                console.warn('Google Drive upload failed:', data.google_drive.error);
                            }
                            
                            // Format phone number (remove +, spaces, etc.)
                            let phone = '{{ client.phone }}'.replace(/\D/g, '');
                            if (phone.startsWith('0')) {
                                phone = '27' + phone.substring(1);
                            }
                            
                            // Create WhatsApp URL
                            const whatsappUrl = 'https://wa.me/' + phone + '?text=' + encodeURIComponent(message);
                            
                            // Open WhatsApp in a new window
                            const newWindow = window.open(whatsappUrl, '_blank');
                            
                            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                                // Show toast notification instead of alert
                                showToast('Please allow pop-ups to open WhatsApp.', 'warning');
                            }
                        } else {
                            console.error('Error preparing WhatsApp share:', data.error);
                            // Show toast notification instead of alert
                            showToast('Error: ' + data.error, 'danger');
                        }
                        
                        // Restore button
                        button.innerHTML = originalButtonText;
                        button.disabled = false;
                    })
                    .catch(error => {
                        console.error('WhatsApp sharing error:', error);
                        // Show toast notification instead of alert
                        showToast('Could not prepare WhatsApp message: ' + error.message, 'danger');
                        
                        // Restore button
                        button.innerHTML = originalButtonText;
                        button.disabled = false;
                    });
            }
        });
    });
</script>
{% endblock %}
